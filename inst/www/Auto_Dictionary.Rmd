---
output: html_document
title: "Data Dictionary"
# Add Shiny components to document
#runtime: shiny
params:
  object: NA
  valid_features: NA
---

```{r Summary HTML function, eval = FALSE, include = FALSE, echo = FALSE, message = FALSE, warning = FALSE}
# Source summary_tags.R if this function is needed in the future
```


<!-- Load libraries -->

```{r libraries, echo = FALSE, message = FALSE, warning = FALSE}
# Import libraries
library(Seurat)
library(SingleCellExperiment)
library(shiny)
library(stats)
library(shinyWidgets)
library(SCEPlots)
library(scExploreR)

# Libraries for formatting text
library(glue)
library(tools)
```

```{r load parameters, echo = FALSE, message = FALSE, warning = FALSE}
# Import parameters from app
object <- params$object
valid_features <- params$valid_features
```

```{css Document CSS, echo = FALSE}
/* Define CSS variables*/
:root {
  /* Specific blue color used by title text and entry headers */
  --text_accent: #082E6B;
  /* Background color for every second metadata entry */
  --even_background: #E1E1E1;
}

.title {
  color: var(--text_accent, blue);
  font-weight: bold;
}

/* Class for category titles */
.category-header {
  color: var(--text_accent, blue);
}

/* category-info */
/* Class for div wrapping info printed for each class */
.category-info {
  padding: 10px 20px;
}

/* Change background color of every even entry*/
.category-info.even{
  background-color: var(--even_background, gray);
}

/* Text formatting classes */
/* Turns text bold and blue*/
.bold-blue {
  color: var(--text_accent, blue);
  font-weight: bold;
}

.large {
  font-size: 1.3em;
}
```

Below is a summary of each metadata category in the current object. This document is most useful as a guide for the advanced subsetting feature. The ID of the category is shown in bold, and the data class (according to R) is shown beneath the ID.

Beneath the class, a summary of the metadata category is given. For categorical data types, unique values are displayed, and for numeric data types, summary statistics are shown. This summary is intended to give an overview of the range of values in each category, to aid in subsetting.

To use string subsetting, the metadata categories and their values **must be entered exactly as they display below**. For more information, see the "How to use String subsetting" tab.

```{r Data Dictionary, echo = FALSE, message = FALSE, warning = FALSE}
# Extract metadata table as a variable
meta_table <- 
  SCEPlots::fetch_metadata(
    object,
    full_table = TRUE
    )

# Define searchable metadata categories 
all_meta_cols <- 
  colnames(meta_table)

# First iteration: build list with information on each metadata category ##### 
metadata_properties <-
  lapply(
    all_meta_cols,
    function(category){
      # Form vector of values for current category
      category_vector <- meta_table[[category]]

      # Class of data in metadata category
      class <- class(category_vector)
      
      # Summary of metadata for printing: depends on class
      if (class == "character"){
        # Character vectors: use unique()
        summary <- unique(category_vector)
        
        } else if (class == "factor"){
          # Factors: use levels()
          summary <- levels(category_vector)
        
        } else if (class %in% c("numeric", "integer")) {
          # For numeric metadata, compute stats
          summary <- summary(category_vector)
        
        } else if (class %in% c("logical")) {
          # Logical metadata: provide TRUE and FALSE, without quotes
          summary <- "TRUE, FALSE"
          }
      
      # For each value, return a list with the class and description
      list(
        `class` = class,
        `summary` = summary
        )
      } # End lapply function
    )

# Add category names to the list of properties
names(metadata_properties) <- all_meta_cols

# Second iteration: create HTML tags from properties list ########

# Even: a variable used to apply classes to every even entry in lapply
even <- FALSE

# Create a list of tags
tagList(
  # Print subtitle first
  # tags$h3(
  #   class = "bold-blue;", 
  #   "Metadata in Current Object"
  # ),
  # tags$p(
  #   ""
  #   ),
  # tags$p(
  #   ""
  #   ),
  lapply(
    # Iterate through each metadata category
    all_meta_cols,
    function(category){
      #Extract metadata properties for current category
      metadata_entry <- metadata_properties[[category]]
    
      # Define class of metadata category
      class <- metadata_entry$class
      
      # List of tags to print for each category
      tag <-
        div(
          class = 
          if (even == FALSE){
            "category-info"
          } else {
            "category-info even"  
            },
        # Name of category
        tags$h4(
          class = 'category-header',
          #style = 'color: #000088;',
          category
          ),
        # Class of category
        tags$p(
          class = "bold-blue",
          # Put class in title case (tools::toTitleCase)
          glue("({toTitleCase(class)})")
        ),
        # Tags for Discription of values: depends on class of category
        if (class %in% c("character", "factor")){
          # Categorical metadata: collapse unique values into a string
          tags$p(
            tags$b("Unique Values: "),
            paste(metadata_entry$summary, collapse = ", ")
          )
        } else if (class %in% c("numeric", "integer")){
          # Numeric metadata
          # Display sumamary statistics
          tagList(
            tags$p(
              tags$b("Min:"),
              metadata_entry$summary[1]
              ),
            tags$p(
              tags$b("Q1:"),
              metadata_entry$summary[2]
              ),
            tags$p(
              tags$b("Median:"),
              metadata_entry$summary[3]
              ),
            tags$p(
              tags$b("Mean:"),
              metadata_entry$summary[4]
              ),
            tags$p(
              tags$b("Q3:"),
              metadata_entry$summary[5]
              ),
            tags$p(
              tags$b("Max:"),
              metadata_entry$summary[6]
              )
          )
        } else if (class == "logical"){
          tags$p(
            tags$b("Values: "),
            # Print the summary string (already displays both choices)
            metadata_entry$summary
          )
        } else {
          # Unforeseen classes
          tags$p(
            style = "color: #804040;",
            "Description unavailable (unforseen datatype)."
          )
        }
      )
      
      # After defining tag, change value of even to alternate classes between 
      # entries
      if (even == TRUE){
        even <<- FALSE
      } else {
        even <<- TRUE
      }
      
      # Return tag and continue iteration 
      tag
    }
  )
)

```

<!-- Feature search bar -->
<!-- Uses Shiny components -->
<!-- This has been disabled for now to avoid running an app from the app -->

<!-- ## Feature Search -->
```{r Feature Search, echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE}
tags$p(
  tags$b("Enter a feature to view feature ID and summary statistics:")
  )
selectizeInput(
  inputId = "feature",
  label = NULL,
  choices = NULL,
  selected = NULL,
  options = 
    list(
      # Add remove button to inputs
      'plugins' = list('remove_button'),
      # Do not allow user to input features not
      # in the list of options
      'create' = FALSE,
      'placeholder' = "enter feature"
      )
  )
```


<!-- Text to display beneath input widget -->
<!-- "When using string subsetting for features, enter the ID below exactly as it appears, and without quotes (see "How to use string subsetting" for more details)." -->

```{r Server-side update of features, echo = FALSE, message = FALSE, warning = FALSE, results = FALSE, eval = FALSE}
# results = FALSE used in this chunk to prevent output of server info
updateSelectizeInput(
  session,
  inputId = "feature",
  choices = valid_features,
  selected = character(0),
  server = TRUE,
  options = 
    list(
      # Add remove button to inputs
      'plugins' = list('remove_button'),
      # Do not allow user to input features not
      # in the list of options
      'create' = FALSE,
      'placeholder' = "enter feature"
      )
  )
```

```{r Feature Output, echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE}
# UI Output displaying information for current feature
renderUI({
  req(input$feature)
  
  feature_summary <-
    FetchData(
      object,
      vars = input$feature
      )[,1] |> 
    summary()
  
  # Print UI below
  tagList(
    # Feature ID
    tags$p(
      class = "bold-blue large",
      tags$b(
        "Feature ID:"
        ),
      input$feature
      ),
    # Summary Statistics
    summary_tags(feature_summary)
    )
  })
```